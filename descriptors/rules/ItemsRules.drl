#created on: 24-Sep-2007
package ItemsRules3

#imports
import com.sapienter.jbilling.server.item.PricingField
import com.sapienter.jbilling.server.item.db.ItemDTO
import com.sapienter.jbilling.server.order.db.OrderLineDTO;
import com.sapienter.jbilling.server.order.db.OrderDTO;
import java.math.BigDecimal;
import com.sapienter.jbilling.server.order.OrderLineBL;
import com.sapienter.jbilling.server.order.OrderBL;


rule "Lemon and Coffee discount"
	when
        $order : OrderDTO( )    # any order
        OrderLineDTO( itemId == 2) from $order.lines # Lemonade
        OrderLineDTO( itemId == 3) from $order.lines # Coffee
        # only if the discount is not already there
        # otherwise an infinite loop happens (the no-loop attribute would
        # have the same effect)
        not ( OrderLineDTO( itemId == 14) from $order.lines )
	then
        OrderLineBL.addItem($order, 14); # 10% discount
        update($order);
end


rule "Lemonade Plan"
    when
        $order : OrderDTO( )    # any order
        $planLine : OrderLineDTO( itemId == 250) from $order.lines # Plan
    then
        $order.getLines().remove($planLine); # Plan is only for grouping
        OrderLineBL.addItem($order, 1); # The monthly lemonade subscription
        update($order);
        # now add an new order
        OrderDTO newOrder = OrderBL.createAsWithLine($order, 251, 1.0);  # The setup fee
        newOrder.setOrderPeriodId(1); # It should be one time
        newOrder.setNotes("As part of plan. ");
        insert(newOrder);
end


rule 'rateOrder test1'
	dialect "java"
when
	$field : PricingField( name == "add" )
	$order  : OrderDTO( )
then
    for (OrderLineDTO line: $order.getLines()) {
        line.setPrice(line.getPrice().add(new BigDecimal($field.getDoubleValue())));
    }
end

rule 'rateOrder test2'
	dialect "java"
when
	$field : PricingField( name == "subtract" )
	$order  : OrderDTO( )
then
    for (OrderLineDTO line: $order.getLines()) {
        line.setPrice(line.getPrice().subtract(new BigDecimal( $field.getDoubleValue())));
    }
end
