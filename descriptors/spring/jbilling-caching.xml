<?xml version="1.0" encoding="UTF-8"?>

<!--
    Document   : jbilling-caching.xml
    Created on : September 14, 2010
    Author     : vikasb
    Description: Database and caching beans (Loaders and Finders) related configuration
-->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jee="http://www.springframework.org/schema/jee"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd
       http://www.springframework.org/schema/tx 
       http://www.springframework.org/schema/tx/spring-tx-2.5.xsd">

    <!-- HSQLDB in-memory database -->
    <bean id="memcacheDataSource" class="org.springframework.jdbc.datasource.SingleConnectionDataSource"
          lazy-init="true">
        <property name="jdbcUrl" value="jdbc:hsqldb:mem:cacheDB" />
        <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
        <property name="username" value="sa" />
		<property name="password" value="" />
	</bean>

    <bean id="memcacheTransactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="memcacheDataSource"/>
    </bean>

    <bean id="memcacheTransactionTemplate" class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager" ref="memcacheTransactionManager"/>
    </bean>

    <bean id="memcacheJdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate">
		<property name="dataSource" ref="memcacheDataSource" />
	</bean>

	<!-- The jdbcReader configuration is only for testing	--> 
	<!-- 
	<bean id="jdbcReader"
		class="com.sapienter.jbilling.server.mediation.task.JDBCReader">
		<property name="parameters">
			<map>
				<entry key="table_name" value="cdr" />
				<entry key="username" value="jbilling" />
				<entry key="driver" value="org.postgresql.Driver" />
				<entry key="timestamp_column_name" value="datevalo" />
				<entry key="where_append" value="and statut=5" />
				<entry key="database_name" value="jbilling_test" />
				<entry key="url" value="jdbc:postgresql://localhost:5432/jbilling_test" />
				<entry key="password" value="" />
			</map>
		</property>
	</bean>
	 -->
	 
	<bean id="fileReader"
		class="com.sapienter.jbilling.server.mediation.task.SeparatorFileReader">
		<property name="parameters">
			 <map>
			 	<entry key="format_file" value="RateCard.xml"/>
			 	<entry key="suffix" value="cvs"/>
			 </map>
		</property>
	</bean>

	<bean id="basicLoader"
		class="com.sapienter.jbilling.server.mediation.cache.BasicLoaderImpl" lazy-init="true" init-method="init">
		<property name="jdbcTemplate" ref="memcacheJdbcTemplate" />
		<property name="reader" ref="fileReader" />
		<property name="indexColumnNames" value="dgts" />
	</bean>
	
	<bean id="pricingFinder" class="com.sapienter.jbilling.server.mediation.cache.PricingFinder" init-method="init">
		<constructor-arg ref="memcacheJdbcTemplate"/>
		<constructor-arg ref="basicLoader"/>
	</bean>
	
</beans>